<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>棚卸しアプリ</title>
    <meta name="description" content="堅牢なエラー処理機能付き棚卸しPWAアプリ">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;棚卸しアプリ&quot;,&quot;short_name&quot;:&quot;棚卸し&quot;,&quot;start_url&quot;:&quot;./&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#fcfcf9&quot;,&quot;theme_color&quot;:&quot;#21808d&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%2321808d'/%3E%3Ctext x='256' y='280' font-family='sans-serif' font-size='200' fill='white' text-anchor='middle'%3E📦%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <!-- 初期化ローディング画面 -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>アプリを初期化中...</h2>
            <p id="loading-message">データベースを準備しています</p>
            <div class="loading-timeout" id="loading-timeout" style="display: none;">
                <p>初期化に時間がかかっています</p>
                <button class="btn btn--primary" onclick="forceStart()">サンプルデータで開始</button>
            </div>
        </div>
    </div>

    <!-- エラー表示モーダル -->
    <div id="error-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>エラーが発生しました</h3>
            <p id="error-message"></p>
            <div class="modal-actions">
                <button class="btn btn--primary" onclick="closeErrorModal()">OK</button>
                <button class="btn btn--secondary" id="retry-button" onclick="retryLastAction()" style="display: none;">再試行</button>
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="main-screen" class="screen" style="display: none;">
        <header class="app-header">
            <h1>棚卸しアプリ</h1>
            <div class="status-info">
                <span id="center-name">センター未設定</span> | 
                <span id="staff-name">担当者未設定</span>
            </div>
        </header>
        
        <main class="main-content">
            <div class="button-grid">
                <button class="main-button btn--primary" onclick="showInventoryScreen()">
                    <span class="button-icon">📱</span>
                    <span class="button-text">棚卸し開始</span>
                </button>
                
                <button class="main-button btn--secondary" onclick="showImportScreen()">
                    <span class="button-icon">📥</span>
                    <span class="button-text">データ取り込み</span>
                </button>
                
                <button class="main-button btn--secondary" onclick="showExportScreen()">
                    <span class="button-icon">📤</span>
                    <span class="button-text">データ出力</span>
                </button>
                
                <button class="main-button btn--secondary" onclick="showEditScreen()">
                    <span class="button-icon">✏️</span>
                    <span class="button-text">編集</span>
                </button>
                
                <button class="main-button btn--secondary" onclick="showSettingsScreen()">
                    <span class="button-icon">⚙️</span>
                    <span class="button-text">設定</span>
                </button>
                
                <button class="main-button btn--outline" onclick="showDataConfirmScreen()">
                    <span class="button-icon">📊</span>
                    <span class="button-text">データ確認</span>
                </button>
            </div>
        </main>
    </div>

    <!-- 棚卸し画面 -->
    <div id="inventory-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>棚卸し</h2>
        </header>
        
        <main class="form-content">
            <div class="form-group">
                <label class="form-label">商品コード</label>
                <div class="input-group">
                    <input type="text" id="product-code" class="form-control" placeholder="商品コードを入力">
                    <button class="btn btn--primary" onclick="startQRScan()">QRスキャン</button>
                </div>
                <div id="qr-reader" class="qr-reader" style="display: none;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">商品名</label>
                <div id="product-name" class="product-display">商品を選択してください</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ロット選択</label>
                <select id="lot-select" class="form-control" onchange="onLotChange()">
                    <option value="">ロットを選択...</option>
                </select>
                <div class="input-group mt-8">
                    <input type="text" id="custom-lot" class="form-control" placeholder="新しいロット番号">
                    <button class="btn btn--secondary" onclick="addCustomLot()">追加</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">数量</label>
                <input type="number" id="quantity" class="form-control" placeholder="数量を入力" min="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">単位</label>
                <select id="unit-select" class="form-control">
                    <option value="個">個</option>
                    <option value="箱">箱</option>
                    <option value="甲">甲</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">棚番号</label>
                <input type="text" id="shelf-number" class="form-control" placeholder="棚番号を入力">
            </div>
            
            <div class="form-actions">
                <button class="btn btn--primary btn--full-width" onclick="registerInventory()" id="register-btn">登録</button>
            </div>
        </main>
    </div>

    <!-- データ取り込み画面 -->
    <div id="import-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>データ取り込み</h2>
        </header>
        
        <main class="form-content">
            <div class="form-group">
                <label class="form-label">商品マスタファイル (CSV)</label>
                <input type="file" id="product-file" class="form-control" accept=".csv" onchange="validateFile(this, 'product')">
                <small class="form-text">形式: コード,名称,カテゴリー,単価,製造元</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">在庫データファイル (CSV)</label>
                <input type="file" id="stock-file" class="form-control" accept=".csv" onchange="validateFile(this, 'stock')">
                <small class="form-text">形式: 商品番号,商品名称,数量,倉庫名,ロット番号</small>
            </div>
            
            <div class="form-group" id="import-progress" style="display: none;">
                <label class="form-label">進捗</label>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">0%</p>
            </div>
            
            <div class="form-actions">
                <button class="btn btn--primary btn--full-width" onclick="importData()" id="import-btn" disabled>データ取り込み開始</button>
            </div>
        </main>
    </div>

    <!-- 設定画面 -->
    <div id="settings-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>設定</h2>
        </header>
        
        <main class="form-content">
            <div class="form-group">
                <label class="form-label">担当者名</label>
                <input type="text" id="staff-name-input" class="form-control" placeholder="担当者名を入力">
            </div>
            
            <div class="form-group">
                <label class="form-label">センター名</label>
                <select id="center-select" class="form-control">
                    <option value="">センターを選択...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">出力形式</label>
                <select id="output-format" class="form-control">
                    <option value="csv">CSV形式</option>
                    <option value="excel">Excel形式</option>
                </select>
            </div>
            
            <div class="form-actions">
                <button class="btn btn--primary btn--full-width" onclick="saveSettings()">設定を保存</button>
                <button class="btn btn--error btn--full-width mt-8" onclick="clearAllData()">全データクリア</button>
            </div>
        </main>
    </div>

    <!-- データ出力画面 -->
    <div id="export-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>データ出力</h2>
        </header>
        
        <main class="form-content">
            <div class="card">
                <div class="card__body">
                    <h3>棚卸しデータ</h3>
                    <p id="export-count">登録件数: 0件</p>
                    <button class="btn btn--primary btn--full-width" onclick="exportInventoryData()">棚卸しデータをダウンロード</button>
                </div>
            </div>
        </main>
    </div>

    <!-- 編集画面 -->
    <div id="edit-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>データ編集</h2>
        </header>
        
        <main class="form-content">
            <div class="search-group">
                <input type="text" id="search-input" class="form-control" placeholder="商品コードで検索" oninput="searchInventoryData()">
            </div>
            
            <div id="edit-list" class="edit-list">
                <p>検索結果がここに表示されます</p>
            </div>
        </main>
    </div>

    <!-- データ確認画面 -->
    <div id="data-confirm-screen" class="screen" style="display: none;">
        <header class="screen-header">
            <button class="back-button btn--outline" onclick="showMainScreen()">← 戻る</button>
            <h2>データ確認</h2>
        </header>
        
        <main class="form-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>商品マスタ</h3>
                    <span id="product-count">0</span>
                </div>
                <div class="stat-card">
                    <h3>在庫データ</h3>
                    <span id="stock-count">0</span>
                </div>
                <div class="stat-card">
                    <h3>棚卸し登録</h3>
                    <span id="inventory-count">0</span>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
</body>
</html>